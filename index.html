<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JLPT N5 Flashcards</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&family=Noto+Sans+JP:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fafaf7;           /* ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ç‡∏≤‡∏ß‡∏ô‡∏ß‡∏• */
  --panel:#ffffff;        /* ‡πÅ‡∏ú‡∏á/‡∏Å‡∏≤‡∏£‡πå‡∏î */
  --ink:#16181d;          /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
  --muted:#6b7280;        /* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≠‡∏á */
  --line:#e8e8e3;         /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ö‡∏≤‡∏á */
  --accent:#3a74ff;       /* ‡∏ü‡πâ‡∏≤‡∏≠‡∏¥‡∏ô‡∏î‡∏¥‡πÇ‡∏Å‡πâ */
  --accent-weak:#eaf1ff;  /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
  --success:#16a34a;
  --danger:#ef4444;
  --radius:16px;
  --shadow:0 6px 18px rgba(20,24,32,.08);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:"Noto Sans Thai","Noto Sans JP",ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
}

.app{max-width:960px;margin:0 auto;padding:20px 16px 96px}

.header{
  position:sticky;top:0;z-index:10;
  padding:8px 0 12px;
  background:linear-gradient(#fafaf7, rgba(250,250,247,.85));
  backdrop-filter:saturate(1.2) blur(4px);
  border-bottom:1px solid var(--line);
}
.toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.title{font-weight:800}
.subtitle{font-size:12px;color:var(--muted)}

.badge{
  padding:6px 10px;border-radius:999px;
  background:var(--accent-weak); color:#2a4fcf;
  font-size:12px;font-weight:700
}
.spacer{flex:1}

.btn{
  appearance:none;border:1px solid var(--line);background:#fff;
  padding:10px 14px;border-radius:12px;cursor:pointer;
  box-shadow:var(--shadow);font-weight:700;color:var(--ink);
  transition:.15s ease transform,.2s ease box-shadow,.2s ease background;
}
.btn:hover{transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn-icon{display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:var(--accent);color:#fff;border-color:transparent}
.btn-success{background:#eaf7ee;color:#135e2b;border-color:#cfead8}
.btn-danger{background:#feeeee;color:#7c2222;border-color:#ffdede}
.btn-ghost{background:#fff}

.select,.input{
  width:100%;max-width:220px;padding:10px 12px;border-radius:12px;
  border:1px solid var(--line);background:#fff;color:var(--ink)
}

.panel{
  background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);
  box-shadow:var(--shadow);padding:12px;margin-top:12px
}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.hidden{display:none!important}

.grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}

.card{
  position:relative;border-radius:20px;border:1px solid var(--line);
  background:var(--panel);box-shadow:var(--shadow);
  padding:18px;min-height:220px; /* ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÅ‡∏•‡πâ‡∏ß */
}
.card-inner{position:relative;transform-style:preserve-3d;transition:transform .5s ease}
.card.flipped .card-inner{transform:rotateY(180deg)}
.card-face{position:absolute;inset:0;padding:18px;backface-visibility:hidden;display:flex;flex-direction:column;gap:10px}
.card-face.back{transform:rotateY(180deg)}
.card-top{display:flex;align-items:center;gap:8px}
.card-main{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;gap:6px}

.kanji{font-size:44px;font-weight:800;letter-spacing:.5px}
.kana{font-size:20px;color:#334155}
.romaji{font-size:14px;color:var(--muted)}
.meaning{font-size:18px;font-weight:800}

.actions-bar{
  display:flex;gap:10px;margin-top:10px
}
.actions-bar .btn{flex:1}
.actions-bar .btn.flip{
  /* ‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö Know + Don't know ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô */
  flex:2;background:var(--accent);color:#fff;border-color:transparent
}

/* backbar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ secondary */
.backbar{display:flex;align-items:center;gap:8px;margin-bottom:6px}
</style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="toolbar">
        <button id="btnBack" class="btn btn-icon hidden" aria-label="Back">
          ‚óÄÔ∏é
        </button>
        <div>
          <div class="title">JLPT N5 Flashcards</div>
          <div class="subtitle">‡∏ù‡∏∂‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î + ‡∏à‡∏î‡∏à‡∏≥‡πÅ‡∏ö‡∏ö‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤</div>
        </div>
        <div class="spacer"></div>
        <span id="statCounter" class="badge">0 / 0</span>
        <button id="btnSettings" class="btn btn-icon">‚öôÔ∏è Settings</button>
        <button id="btnFilter" class="btn btn-icon">üîé Filter</button>
      </div>
      <div id="panelSettings" class="panel hidden" role="region" aria-label="Settings">
        <div class="backbar">
          <button class="btn btn-icon" data-action="back">‚óÄÔ∏é ‡∏Å‡∏•‡∏±‡∏ö</button>
          <strong>Settings</strong>
        </div>
        <div class="row">
          <label>‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°
            <select id="modeSelect" class="select">
              <option value="mixed">‡∏™‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ú‡∏™‡∏°)</option>
              <option value="category">‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î (Category)</option>
            </select>
          </label>
          <label>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
            <select id="frontSelect" class="select">
              <option value="kanji">Kanji</option>
              <option value="kana">Kana</option>
              <option value="meaning">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ (‡πÑ‡∏ó‡∏¢)</option>
            </select>
          </label>
          <label>‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á
            <select id="backSelect" class="select">
              <option value="meaning">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ (‡πÑ‡∏ó‡∏¢)</option>
              <option value="kana">Kana</option>
              <option value="romaji">Romaji</option>
              <option value="kanji">Kanji</option>
            </select>
          </label>
        </div>
      </div>

      <div id="panelFilter" class="panel hidden" role="region" aria-label="Filter">
        <div class="backbar">
          <button class="btn btn-icon" data-action="back">‚óÄÔ∏é ‡∏Å‡∏•‡∏±‡∏ö</button>
          <strong>Filter</strong>
        </div>
        <div class="row">
          <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö
            <select id="levelSelect" class="select">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="N5">N5</option>
              <option value="N4">N4</option>
            </select>
          </label>
          <label>‡∏´‡∏°‡∏ß‡∏î (Category)
            <select id="categorySelect" class="select">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            </select>
          </label>
          <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô/‡πÑ‡∏ó‡∏¢)
            <input id="searchInput" class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‚Ä¶ (‡πÄ‡∏ä‡πà‡∏ô „ÅÑ„Åè / Ë°å„Åè / ‡πÑ‡∏õ)">
          </label>
          <button id="btnApplyFilter" class="btn btn-primary">Apply</button>
          <button id="btnClearFilter" class="btn btn-ghost">Clear</button>
        </div>
      </div>
    </header>

    <main>
<div class="grid">
  <section class="card" id="flashCard" tabindex="0" aria-label="Flashcard (tap/‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ flip)">
    <div class="card-inner">
      <div class="card-face front">
        <div class="card-top">
          <span id="badgeLevel" class="badge">N5</span>
          <span id="badgeCategory" class="badge">‡∏´‡∏°‡∏ß‡∏î</span>
        </div>
        <div class="card-main">
          <div id="frontMain" class="kanji">‚Ä¶</div>
          <div id="frontSub1" class="kana">‚Ä¶</div>
          <div id="frontSub2" class="romaji">‚Ä¶</div>
        </div>
      </div>
      <div class="card-face back">
        <div class="card-top">
          <span class="badge">‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•</span>
        </div>
        <div class="card-main">
          <div id="backMain" class="meaning">‚Ä¶</div>
          <div id="backSub1" class="kana">‚Ä¶</div>
          <div id="backSub2" class="romaji">‚Ä¶</div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ‡πÅ‡∏ñ‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà ‚Äú‡∏ô‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‚Äù ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô -->
<div class="actions-bar">
  <button id="btnDontKnow" class="btn btn-danger">Don‚Äôt know</button>
  <button id="btnFlip" class="btn flip">Flip</button>
  <button id="btnKnow" class="btn btn-success">Know</button>
</div>
      <div class="panel" style="margin-top:18px">
        <div class="row">
          <button id="btnPrev" class="btn btn-ghost">‚ü® ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
          <button id="btnNext" class="btn btn-ghost">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ü©</button>
          <div class="spacer"></div>
          <button id="btnShuffle" class="btn">üîÄ ‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà</button>
          <button id="btnResetProgress" class="btn btn-ghost">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
        </div>
      </div>

      <!-- ‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏™‡∏£‡∏∏‡∏õ‡∏î‡∏≤‡∏ß‚Äù ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î) -->
      <section id="starSummary" class="panel hidden">
        <div class="backbar">
          <button class="btn btn-icon" data-action="back">‚óÄÔ∏é ‡∏Å‡∏•‡∏±‡∏ö</button>
          <strong>‡∏™‡∏£‡∏∏‡∏õ‡∏î‡∏≤‡∏ß (‡∏ã‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà)</strong>
        </div>
        <div id="starBuckets"></div>
      </section>
    </main>
  </div>
<script>
/* ========= Utils ========= */
const qs = (s, el=document)=>el.querySelector(s);
const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
const clamp = (n,min,max)=>Math.max(min, Math.min(max,n));
const escapeHTML = (str) => (str??"")
  .toString()
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#39;");

const persist = {
  get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
};

/* ========= Data mapping =========
‡πÑ‡∏ü‡∏•‡πå n5-500 word.json (‡∏ü‡∏¥‡∏•‡∏î‡πå):
- kanji -> kanji
- kana -> kana
- romaji -> romaji
- thai -> meaning
- jlpt -> level
- category -> category
‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ kanji ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å kana
*/
const SOURCE_URL = 'n5-500 word.json';

let rawCards = [];
let cards = [];       // ‡∏´‡∏•‡∏±‡∏á filter/sort
let idx = 0;          // index ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
let showingBack = false;

// ‡πÄ‡∏Å‡πá‡∏ö ‚Äú‡∏î‡∏≤‡∏ß‚Äù ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏π‡πâ/‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ ‡πÅ‡∏ö‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô UI
let stars = persist.get('stars', {});      // key = id (hash text), value = 0..3
let mastery = persist.get('mastery', {});  // { id: {know: n, dont: n} }

const settings = persist.get('settings', {
  mode: 'mixed',
  front: 'kanji',
  back: 'meaning'
});

const filters = persist.get('filters', {
  level: '',
  category: '',
  search: ''
});

function hashId(o){
  const s = [o.kanji,o.kana,o.romaji,o.meaning,o.level,o.category].join('|');
  let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
  return String(h);
}

/* ========= Load & Prepare ========= */
async function loadData(){
  try{
    const res = await fetch(SOURCE_URL);
    const json = await res.json();
    rawCards = (json.vocab ?? json).map(x => ({
      kanji: x.kanji?.trim() || '',
      kana: x.kana?.trim() || '',
      romaji: x.romaji?.trim() || '',
      meaning: (x.thai ?? x.meaning ?? '').trim(),
      level: (x.jlpt ?? x.level ?? '').trim() || 'N5',
      category: (x.category ?? '').trim() || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
    })).map(o=>{
      if(!o.kanji) o.kanji = o.kana || o.meaning;
      return {...o, id: hashId(o)};
    });
  }catch(e){
    console.error('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', e);
    rawCards = [{
      kanji:'Ë°å„Åè', kana:'„ÅÑ„Åè', romaji:'iku', meaning:'‡πÑ‡∏õ', level:'N5', category:'‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'
    }].map(o=>({...o, id: hashId(o)}));
  }
  buildCategoryOptions();
  applyAll();
}

/* ========= Filtering / Shuffling / Mode ========= */
function buildCategoryOptions(){
  const set = new Set(rawCards.map(c=>c.category).filter(Boolean));
  const sel = qs('#categorySelect');
  sel.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + [...set].sort().map(c=>`<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join('');
}

function applyFilters(){
  const {level, category, search} = filters;
  const t = (search||'').toLowerCase().trim();
  let out = rawCards.filter(c=>{
    if(level && c.level!==level) return false;
    if(category && c.category!==category) return false;
    if(t){
      const hay = [c.kanji,c.kana,c.romaji,c.meaning].join(' ').toLowerCase();
      if(!hay.includes(t)) return false;
    }
    return true;
  });
  if(settings.mode==='category' && !filters.category){
    // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î category ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÅ‡∏£‡∏Å‡πÉ‡∏´‡πâ
    const firstCat = out[0]?.category || rawCards[0]?.category || '';
    filters.category = firstCat;
    persist.set('filters', filters);
    out = rawCards.filter(c=>c.category===firstCat && (!level || c.level===level));
    qs('#categorySelect').value = firstCat;
  }
  // ‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏ñ‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ (dont) ‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢ ‡πÇ‡∏ú‡∏•‡πà‡∏ö‡πà‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
  out = weightedShuffle(out);
  return out;
}

function weightedShuffle(arr){
  // weight = 1 + dont - know + (1 - star/3)
  const items = arr.map(c=>{
    const m = mastery[c.id] || {know:0, dont:0};
    const star = stars[c.id] ?? 0;
    const w = Math.max(0.2, 1 + (m.dont - m.know)*0.7 + (1 - (star/3))*0.5);
    return {c, w};
  });
  // roulette wheel
  const result=[];
  const pool=[...items];
  while(pool.length){
    const sum = pool.reduce((s,x)=>s+x.w,0);
    let r = Math.random()*sum;
    let pickIdx = 0;
    for(let i=0;i<pool.length;i++){
      r -= pool[i].w;
      if(r<=0){ pickIdx=i; break; }
    }
    result.push(pool[pickIdx].c);
    pool.splice(pickIdx,1);
  }
  return result;
}

function applyAll(){
  cards = applyFilters();
  idx = clamp(idx, 0, Math.max(0, cards.length-1));
  showingBack = false;
  updateStat();
  renderCard();
}

/* ========= Render ========= */
function setFrontBackDisplay(frontKey, backKey, item){
  // Front
  let frontMain='', frontSub1='', frontSub2='';
  if(frontKey==='kanji'){ frontMain=item.kanji; frontSub1=item.kana; frontSub2=item.romaji; }
  else if(frontKey==='kana'){ frontMain=item.kana || item.kanji; frontSub1=item.kanji; frontSub2=item.romaji; }
  else if(frontKey==='meaning'){ frontMain=item.meaning; frontSub1=item.kana || item.kanji; frontSub2=item.romaji; }

  qs('#frontMain').textContent = frontMain || '‚Äî';
  qs('#frontSub1').textContent = frontSub1 || '';
  qs('#frontSub2').textContent = frontSub2 || '';

  // Back
  let backMain='', backSub1='', backSub2='';
  if(backKey==='meaning'){ backMain=item.meaning; backSub1=item.kana; backSub2=item.romaji; }
  else if(backKey==='kana'){ backMain=item.kana || item.kanji; backSub1=item.meaning; backSub2=item.romaji; }
  else if(backKey==='romaji'){ backMain=item.romaji || item.kana; backSub1=item.kana || item.kanji; backSub2=item.meaning; }
  else if(backKey==='kanji'){ backMain=item.kanji; backSub1=item.kana; backSub2=item.romaji; }

  qs('#backMain').textContent = backMain || '‚Äî';
  qs('#backSub1').textContent = backSub1 || '';
  qs('#backSub2').textContent = backSub2 || '';
}

function renderCard(){
  const cardEl = qs('#flashCard');
  cardEl.classList.toggle('flipped', showingBack);

  const item = cards[idx];
  if(!item){
    qs('#frontMain').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç';
    qs('#frontSub1').textContent = '';
    qs('#frontSub2').textContent = '';
    qs('#backMain').textContent = '';
    qs('#backSub1').textContent = '';
    qs('#backSub2').textContent = '';
    qs('#badgeLevel').textContent = '';
    qs('#badgeCategory').textContent = '';
    return;
  }
  qs('#badgeLevel').textContent = item.level || '‚Äî';
  qs('#badgeCategory').textContent = item.category || '‚Äî';

  setFrontBackDisplay(settings.front, settings.back, item);
}

function updateStat(){
  qs('#statCounter').textContent = `${cards.length? (idx+1):0} / ${cards.length}`;
}

/* ========= Navigation & Actions ========= */
function next(){ if(!cards.length) return; idx = (idx+1)%cards.length; showingBack=false; updateStat(); renderCard(); }
function prev(){ if(!cards.length) return; idx = (idx-1+cards.length)%cards.length; showingBack=false; updateStat(); renderCard(); }
function flip(){ showingBack = !showingBack; renderCard(); }

function markKnow(val){ // val: true=know, false=dont
  const item = cards[idx]; if(!item) return;
  const rec = mastery[item.id] || {know:0, dont:0};
  if(val) rec.know++; else rec.dont++;
  mastery[item.id] = rec;
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‚Äú‡∏î‡∏≤‡∏ß‚Äù ‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ : ‡∏£‡∏π‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏•‡∏î‡∏•‡∏á
  const score = Math.max(0, Math.min(3, Math.round(rec.know - rec.dont/2)));
  stars[item.id] = score;
  persist.set('mastery', mastery);
  persist.set('stars', stars);
  next();
}

/* ========= Star Summary (‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î) ========= */
function showStarSummary(){
  const box = qs('#starBuckets');
  const buckets = {0:[],1:[],2:[],3:[]};
  for(const c of rawCards){
    const s = stars[c.id] ?? 0;
    buckets[s].push(c);
  }
  box.innerHTML = [3,2,1,0].map(st => {
    const list = buckets[st].slice(0,100).map(it=>`<li>${escapeHTML(it.kanji)} ‚Äî ${escapeHTML(it.meaning)} <small>(${escapeHTML(it.kana||'')})</small></li>`).join('');
    const more = buckets[st].length>100 ? `<li>‚Ä¶‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${buckets[st].length-100} ‡∏Ñ‡∏≥</li>`: '';
    return `
      <div class="panel" style="margin-top:12px">
        <strong>‚≠êÔ∏è √ó ${st}</strong> ‚Äî ${buckets[st].length} ‡∏Ñ‡∏≥
        <ol style="margin-top:8px">${list}${more}</ol>
      </div>`;
  }).join('');
}

/* ========= Panels & Back button ========= */
function openPanel(which){
  // which: 'settings' | 'filter' | 'star'
  qs('#panelSettings').classList.toggle('hidden', which!=='settings');
  qs('#panelFilter').classList.toggle('hidden', which!=='filter');
  qs('#starSummary').classList.toggle('hidden', which!=='star');
  qs('#btnBack').classList.toggle('hidden', which===null);
  if(which==='star') showStarSummary();
}
function closePanels(){ openPanel(null); }

/* ========= Wire UI ========= */
function bindUI(){
  qs('#btnSettings').addEventListener('click', ()=>openPanel('settings'));
  qs('#btnFilter').addEventListener('click', ()=>openPanel('filter'));
  qs('#btnBack').addEventListener('click', closePanels);
  qsa('[data-action="back"]').forEach(b=>b.addEventListener('click', closePanels));

  qs('#btnPrev').addEventListener('click', prev);
  qs('#btnNext').addEventListener('click', next);
  qs('#btnFlip').addEventListener('click', flip);
  qs('#btnKnow').addEventListener('click', ()=>markKnow(true));
  qs('#btnDontKnow').addEventListener('click', ()=>markKnow(false));
  qs('#btnShuffle').addEventListener('click', ()=>{ cards = weightedShuffle(cards); idx=0; showingBack=false; updateStat(); renderCard(); });
  qs('#btnResetProgress').addEventListener('click', ()=>{
    if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≥ (‡∏î‡∏≤‡∏ß/‡∏£‡∏π‡πâ/‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){
      stars={}; mastery={};
      persist.set('stars',stars); persist.set('mastery',mastery);
      alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }
  });

  // Tap/Click ‡∏Å‡∏≤‡∏£‡πå‡∏î = flip (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á)
  const card = qs('#flashCard');
  card.addEventListener('click', (e)=>{
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô actions ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà flip ‡∏ã‡πâ‡∏≥
    if(e.target.closest('.actions')) return;
    flip();
  });

  // Keyboard
  document.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowRight') next();
    else if(e.key==='ArrowLeft') prev();
    else if(e.key===' '){ e.preventDefault(); flip(); }
    else if(e.key==='1') markKnow(false);
    else if(e.key==='2') markKnow(true);
  });

  // Settings
  const modeSel = qs('#modeSelect');
  const frontSel = qs('#frontSelect');
  const backSel = qs('#backSelect');
  modeSel.value = settings.mode; frontSel.value = settings.front; backSel.value = settings.back;

  modeSel.addEventListener('change', ()=>{
    settings.mode = modeSel.value; persist.set('settings', settings); applyAll();
  });
  frontSel.addEventListener('change', ()=>{
    settings.front = frontSel.value; persist.set('settings', settings); renderCard();
  });
  backSel.addEventListener('change', ()=>{
    settings.back = backSel.value; persist.set('settings', settings); renderCard();
  });

  // Filter
  qs('#levelSelect').value = filters.level;
  qs('#categorySelect').value = filters.category;
  qs('#searchInput').value = filters.search;

  qs('#btnApplyFilter').addEventListener('click', ()=>{
    filters.level = qs('#levelSelect').value;
    filters.category = qs('#categorySelect').value;
    filters.search = qs('#searchInput').value.trim();
    persist.set('filters', filters);
    applyAll();
    closePanels();
  });
  qs('#btnClearFilter').addEventListener('click', ()=>{
    filters.level=''; filters.category=''; filters.search='';
    persist.set('filters', filters);
    qs('#levelSelect').value=''; qs('#categorySelect').value=''; qs('#searchInput').value='';
    applyAll();
  });

  // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏î‡∏≤‡∏ß‚Äù ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‚Äî ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ã‡∏• openPanel('star')
}

/* ========= Init ========= */
document.addEventListener('DOMContentLoaded', async ()=>{
  bindUI();
  await loadData();
});
</script>
</body>
</html>
