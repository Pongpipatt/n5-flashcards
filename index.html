<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>JLPT N5 Flashcards</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">
  <style>
    /* ======= Part 2/3 ‚Äì CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏û‡∏≤‡∏£‡πå‡∏ó 2) ======= */
  </style>
</head>
<body>
  <!-- Top App Bar -->
  <header class="appbar">
    <button class="icon-btn back-btn" aria-label="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö" data-nav="back" hidden>
      <span>‚Äπ</span>
    </button>
    <h1 class="app-title">JLPT N5 Flashcards</h1>

    <div class="appbar-right">
      <div class="counter-pill"><span id="progressIndex">1</span>/<span id="progressTotal">1</span></div>
      <button class="chip ghost" id="btnSettings" aria-haspopup="dialog">‚öôÔ∏é Settings</button>
      <button class="chip ghost" id="btnFilter" aria-haspopup="dialog">üîé Filter</button>
    </div>
  </header>

  <!-- Notice / hint -->
  <section class="hint">
    <p>‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î + ‡∏à‡∏î‡∏à‡∏≥‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡πà‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡πÅ‡∏ï‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏•‡∏¥‡∏Å)</p>
  </section>

  <!-- Category chips -->
  <section class="chip-row" id="categoryRow">
    <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
  </section>

  <!-- Flashcard Area -->
  <main class="stage">
    <div class="card-wrap">
      <div class="card" id="flashcard" tabindex="0" role="button" aria-label="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î">
        <div class="card-face card-front">
          <div class="word-kanji" id="wordKanji">Ë°å„Åè</div>
          <div class="word-kana" id="wordKana">„ÅÑ„Åè</div>
          <div class="word-romaji" id="wordRomaji">iku</div>
          <!-- *‡∏à‡∏á‡πÉ‡∏à‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏î‡∏≤‡∏ß‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î* -->
        </div>
        <div class="card-face card-back">
          <div class="meaning" id="wordMeaning">‡πÑ‡∏õ / to go</div>
          <div class="meta">
            <span class="meta-badge" id="wordLevel">N5</span>
            <span class="meta-badge" id="wordCategory">‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Big Flip (‡∏Å‡∏î‡∏¢‡∏≤‡∏ß‡πÄ‡∏ó‡πà‡∏≤ Know + Don't know) -->
    <div class="action-row">
      <button id="btnFlip" class="btn flip">Flip</button>
    </div>

    <!-- Know / Don't know -->
    <div class="action-row">
      <button id="btnKnow" class="btn success">‚úì Know</button>
      <button id="btnDont" class="btn danger">‚úó Don‚Äôt know</button>
    </div>

    <!-- Nav row -->
    <div class="nav-row">
      <button id="btnPrev" class="chip">‚Äπ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <button id="btnNext" class="chip">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Ä∫</button>
    </div>

    <!-- Utility row -->
    <div class="utility-row">
      <button id="btnShuffle" class="chip icon-left">üîÄ ‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà</button>
      <button id="btnStars" class="chip outline">üìä ‡∏£‡∏µ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
    </div>
  </main>

  <!-- ========== Sheets / Pages ========== -->

  <!-- Filter Sheet -->
  <dialog id="sheetFilter" class="sheet">
    <div class="sheet-head">
      <button class="icon-btn" data-close="sheetFilter" aria-label="‡∏õ‡∏¥‡∏î">‚úï</button>
      <h3>Filter</h3>
    </div>
    <div class="sheet-body">
      <div class="form-row">
        <label class="lbl">‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
        <div class="pill-group" id="levelPills">
          <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>
      </div>
      <div class="form-row">
        <label class="lbl">‡∏´‡∏°‡∏ß‡∏î</label>
        <div class="pill-group" id="categoryPills">
          <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>
      </div>
      <div class="form-row">
        <label class="lbl">‡∏ä‡∏ô‡∏¥‡∏î‡∏Ñ‡∏≥ (POS)</label>
        <div class="pill-group" id="posPills">
          <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>
      </div>
    </div>
    <div class="sheet-foot">
      <button class="btn ghost" data-close="sheetFilter">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="applyFilter" class="btn primary">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
    </div>
  </dialog>

  <!-- Settings Sheet -->
  <dialog id="sheetSettings" class="sheet">
    <div class="sheet-head">
      <button class="icon-btn" data-close="sheetSettings" aria-label="‡∏õ‡∏¥‡∏î">‚úï</button>
      <h3>Settings</h3>
    </div>
    <div class="sheet-body">
      <label class="switch">
        <input type="checkbox" id="toggleTapToFlip" checked>
        <span>‡πÅ‡∏ï‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠ Flip</span>
      </label>
      <label class="switch">
        <input type="checkbox" id="toggleAutoAdvance" checked>
        <span>‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
      </label>
      <button id="btnReset" class="chip danger">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
    </div>
    <div class="sheet-foot">
      <button class="btn primary" data-close="sheetSettings">‡∏õ‡∏¥‡∏î</button>
    </div>
  </dialog>

  <!-- Stars / Review Page -->
  <section id="starsPage" hidden>
    <div class="subbar">
      <button class="icon-btn back-btn" data-nav="home">‚Äπ</button>
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏î‡∏≤‡∏ß</h2>
    </div>
    <div class="stars-wrap" id="starsWrap">
      <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° 1‚òÖ ‚Äì 5‚òÖ -->
    </div>
  </section>

  <script>
    /* ======= Part 3/3 ‚Äì JS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏û‡∏≤‡∏£‡πå‡∏ó 3) ======= */
  </script>
</body>
</html>
:root{
  --bg:#f6fbff;
  --card:#ffffff;
  --ink:#0f172a;
  --ink-soft:#475569;
  --pri:#2a86ff;
  --pri-ink:#fff;
  --success:#22c55e;
  --danger:#ef4444;
  --chip:#e8f1ff;
  --outline:#dbe7ff;
  --shadow:0 8px 24px rgba(15,23,42,.06);
  --radius:18px;
}

*{box-sizing:border-box}
html,body{height:100%;}
body{
  margin:0;background:var(--bg);
  font-family:'Noto Sans Thai','Noto Sans JP',system-ui,Arial,sans-serif;
  color:var(--ink);
}

.appbar{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;gap:12px;
  padding:14px 16px;background:#fff;border-bottom:1px solid #eef2ff;
}
.app-title{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px;}
.appbar-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.counter-pill{background:#eef6ff;border:1px solid var(--outline);padding:6px 10px;border-radius:999px;font-weight:700;}

.icon-btn{
  border:none;background:#fff;width:40px;height:40px;border-radius:12px;
  box-shadow:var(--shadow);display:inline-grid;place-items:center;cursor:pointer;
}
.icon-btn span{font-size:22px;transform:translateY(-1px)}

.hint{padding:8px 16px 0;color:var(--ink-soft);font-size:14px}
.chip-row{display:flex;gap:8px;overflow:auto;padding:8px 16px 0 16px}
.chip{border:none;background:#fff;border-radius:999px;padding:10px 14px;box-shadow:var(--shadow);cursor:pointer}
.chip.ghost{background:#fff;border:1px solid var(--outline)}
.chip.outline{background:var(--chip);border:1px solid var(--outline)}
.chip.icon-left{display:inline-flex;gap:8px;align-items:center}
.chip.danger{background:#ffeaea;border:1px solid #ffd4d4;color:#c02626}

.stage{padding:16px;max-width:880px;margin:0 auto}
.card-wrap{display:grid;place-items:center;margin:10px 0 14px}
.card{
  width:min(720px,92vw);min-height:260px;background:var(--card);
  border-radius:24px;box-shadow:var(--shadow);
  position:relative;transform-style:preserve-3d;transition:transform .5s ease;
  padding:28px 24px;cursor:pointer;
}
.card.flipped{transform:rotateY(180deg)}
.card-face{position:absolute;inset:0;padding:28px 24px;backface-visibility:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center}
.card-back{transform:rotateY(180deg)}
.word-kanji{font-family:'Noto Sans JP',sans-serif;font-size:64px;font-weight:700;line-height:1.1}
.word-kana{font-family:'Noto Sans JP',sans-serif;font-size:22px;margin-top:8px;color:var(--ink-soft)}
.word-romaji{font-size:16px;color:#8b98b7;margin-top:4px}
.meaning{font-size:24px;font-weight:700;text-align:center}
.meta{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.meta-badge{background:#eef6ff;border:1px solid var(--outline);padding:6px 10px;border-radius:999px;font-size:12px}

.action-row{display:flex;gap:12px;justify-content:center;margin:12px 0}
.btn{
  border:none;border-radius:999px;padding:14px 18px;font-weight:700;cursor:pointer;
  box-shadow:var(--shadow);
}
.btn.flip{
  background:#fff;border:1px solid var(--outline);width:min(720px,92vw);
}
.btn.success{background:var(--success);color:#fff;min-width:180px}
.btn.danger{background:var(--danger);color:#fff;min-width:180px}
.btn.primary{background:var(--pri);color:var(--pri-ink)}
.btn.ghost{background:#fff;border:1px solid var(--outline)}

.nav-row,.utility-row{
  display:flex;gap:10px;justify-content:center;margin-top:8px;flex-wrap:wrap
}

.sheet{width:min(780px,94vw);border:none;border-radius:20px;padding:0;box-shadow:var(--shadow)}
.sheet::backdrop{background:rgba(15,23,42,.35)}
.sheet-head{display:flex;align-items:center;gap:8px;padding:14px 16px;border-bottom:1px solid #eef2ff;background:#fff;border-radius:20px 20px 0 0}
.sheet-body{padding:16px 16px 6px;background:#fff;max-height:min(64vh,560px);overflow:auto}
.sheet-foot{padding:12px 16px;display:flex;gap:10px;justify-content:flex-end;background:#fff;border-top:1px solid #eef2ff;border-radius:0 0 20px 20px}
.form-row{margin:12px 0}
.lbl{display:block;margin:6px 0 10px;font-weight:700}
.pill-group{display:flex;gap:8px;flex-wrap:wrap}
.pill{border:1px solid var(--outline);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer}
.pill.active{background:#2a86ff;color:#fff;border-color:#2a86ff}

.switch{display:flex;align-items:center;gap:10px;margin:8px 0}
.switch input{width:18px;height:18px}

.subbar{position:sticky;top:0;z-index:9;background:#fff;display:flex;align-items:center;gap:8px;padding:12px 14px;border-bottom:1px solid #eef2ff}
.stars-wrap{padding:14px 16px;max-width:860px;margin:0 auto}
.star-group{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:12px 12px 4px;margin-bottom:14px}
.star-head{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.word-list{display:flex;flex-wrap:wrap;gap:8px}
.word-chip{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px}

@media (min-width:960px){
  .app-title{font-size:20px}
  .word-kanji{font-size:72px}
  .btn.success,.btn.danger{min-width:220px}
}
// ========= Data Loading =========
const STORAGE_KEY = 'n5flash_v1';
const state = {
  all: [],
  pool: [],
  idx: 0,
  filters: { level: new Set(['N5']), category: new Set(), pos: new Set() },
  tapToFlip: true,
  autoAdvance: true,
  stars: {}, // id -> 0..5
};

const sample = [
  {"kanji":"Ë°å„Åè","kana":"„ÅÑ„Åè","romaji":"iku","meaning":"‡πÑ‡∏õ / to go","level":"N5","category":"‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á","pos":"verb"},
  {"kanji":"Êù•„Çã","kana":"„Åè„Çã","romaji":"kuru","meaning":"‡∏°‡∏≤ / to come","level":"N5","category":"‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á","pos":"verb"},
  {"kanji":"Â∏∞„Çã","kana":"„Åã„Åà„Çã","romaji":"kaeru","meaning":"‡∏Å‡∏•‡∏±‡∏ö / to return","level":"N5","category":"‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á","pos":"verb"},
  {"kanji":"Ë™≠„ÇÄ","kana":"„Çà„ÇÄ","romaji":"yomu","meaning":"‡∏≠‡πà‡∏≤‡∏ô / to read","level":"N5","category":"‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°","pos":"verb"},
  {"kanji":"Êõ∏„Åè","kana":"„Åã„Åè","romaji":"kaku","meaning":"‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô / to write","level":"N5","category":"‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°","pos":"verb"},
  {"kanji":"Êöë„ÅÑ","kana":"„ÅÇ„Å§„ÅÑ","romaji":"atsui","meaning":"‡∏£‡πâ‡∏≠‡∏ô (‡∏≠‡∏≤‡∏Å‡∏≤‡∏®)","level":"N5","category":"‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®","pos":"adj-i"},
  {"kanji":"ÂØí„ÅÑ","kana":"„Åï„ÇÄ„ÅÑ","romaji":"samui","meaning":"‡∏´‡∏ô‡∏≤‡∏ß (‡∏≠‡∏≤‡∏Å‡∏≤‡∏®)","level":"N5","category":"‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®","pos":"adj-i"},
  {"kanji":"Áä¨","kana":"„ÅÑ„Å¨","romaji":"inu","meaning":"‡∏™‡∏∏‡∏ô‡∏±‡∏Ç / dog","level":"N5","category":"‡∏™‡∏±‡∏ï‡∏ß‡πå","pos":"noun"},
  {"kanji":"Áå´","kana":"„Å≠„Åì","romaji":"neko","meaning":"‡πÅ‡∏°‡∏ß / cat","level":"N5","category":"‡∏™‡∏±‡∏ï‡∏ß‡πå","pos":"noun"},
  {"kanji":"Â≠¶Ê†°","kana":"„Åå„Å£„Åì„ÅÜ","romaji":"gakkou","meaning":"‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","level":"N5","category":"‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà","pos":"noun"}
];

async function loadData() {
  try {
    const res = await fetch('data/n5-500-word.json', {cache:'no-store'});
    if (!res.ok) throw new Error('not found');
    const data = await res.json();
    return normalize(data);
  } catch {
    return normalize(sample);
  }
}
function normalize(arr){
  // ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ field pos; ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏ä‡πâ type/‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏Å‡πà‡∏≤ ‡πÜ
  return arr.map((x,i)=>({
    id: i + '_' + (x.kanji||x.kana),
    kanji: x.kanji ?? '',
    kana: x.kana ?? '',
    romaji: x.romaji ?? '',
    meaning: x.meaning ?? x.thai ?? '',
    level: x.level ?? x.jlpt ?? 'N5',
    category: x.category ?? '',
    pos: x.pos ?? x.type ?? '',
  }));
}

// ========= Storage =========
function save(){
  const payload = {
    stars: state.stars,
    filters: {level:[...state.filters.level], category:[...state.filters.category], pos:[...state.filters.pos]},
    tapToFlip: state.tapToFlip,
    autoAdvance: state.autoAdvance,
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
}
function restore(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const j = JSON.parse(raw);
    state.stars = j.stars || {};
    if(j.filters){
      state.filters.level = new Set(j.filters.level||[]);
      state.filters.category = new Set(j.filters.category||[]);
      state.filters.pos = new Set(j.filters.pos||[]);
    }
    state.tapToFlip = j.tapToFlip ?? true;
    state.autoAdvance = j.autoAdvance ?? true;
  }catch{}
}

// ========= UI Helpers =========
const $ = (q)=>document.querySelector(q);
const $$ = (q)=>document.querySelectorAll(q);

function setCard(word){
  $('#wordKanji').textContent = word.kanji || '‚Äî';
  $('#wordKana').textContent = word.kana || '';
  $('#wordRomaji').textContent = word.romaji || '';
  $('#wordMeaning').textContent = word.meaning || '';
  $('#wordLevel').textContent = word.level || '';
  $('#wordCategory').textContent = word.category || '';
  $('#flashcard').classList.remove('flipped');

  $('#progressIndex').textContent = state.idx + 1;
  $('#progressTotal').textContent = state.pool.length;
}

function applyFilters(){
  const {level, category, pos} = state.filters;
  state.pool = state.all.filter(v => 
    (level.size ? level.has(v.level) : true) &&
    (category.size ? category.has(v.category) : true) &&
    (pos.size ? pos.has(v.pos) : true)
  );
  if(state.pool.length===0){ state.pool = [...state.all]; }
  state.idx = 0;
  setCard(state.pool[state.idx]);
  paintCategoryRow();
}

function paintCategoryRow(){
  const row = $('#categoryRow');
  row.innerHTML = '';
  const cats = [...new Set(state.pool.map(v=>v.category).filter(Boolean))];
  cats.forEach(c=>{
    const b = document.createElement('button');
    b.className = 'chip';
    b.textContent = c || '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ';
    b.onclick = ()=> {
      // toggle filter category
      if(state.filters.category.has(c)) state.filters.category.delete(c);
      else { state.filters.category.clear(); state.filters.category.add(c); }
      save(); applyFilters();
      openToast(`‡∏ù‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î: ${c}`);
    };
    row.appendChild(b);
  });
}

function openToast(msg){
  // ‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡πÉ‡∏ä‡πâ native alert ‡πÅ‡∏ó‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô
  // ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö snackbar ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ
  console.log(msg);
}

// ========= Actions =========
function next(delta = 1){
  state.idx = (state.idx + delta + state.pool.length) % state.pool.length;
  setCard(state.pool[state.idx]);
}
function flip(){
  $('#flashcard').classList.toggle('flipped');
}
function mark(know){
  const w = state.pool[state.idx];
  const cur = state.stars[w.id] ?? 0;
  if(know) state.stars[w.id] = Math.min(5, cur + 1);
  else state.stars[w.id] = Math.max(0, cur - 1);
  save();
  if(state.autoAdvance) next(1);
}

// ========= Sheets =========
function bindSheet(btnId, sheetId){
  $(btnId).addEventListener('click', ()=> $(sheetId).showModal());
  $(`${sheetId} [data-close="${sheetId.substring(1)}"]`)?.addEventListener('click', ()=> $(sheetId).close());
}
bindSheet('#btnFilter', '#sheetFilter');
bindSheet('#btnSettings', '#sheetSettings');

// Build filters
function buildFilterUI(){
  const levels = [...new Set(state.all.map(v=>v.level))];
  const cats = [...new Set(state.all.map(v=>v.category).filter(Boolean))];
  const poss = [...new Set(state.all.map(v=>v.pos).filter(Boolean))];

  const mk = (arr,set,wrapId)=>{
    const wrap = $(wrapId); wrap.innerHTML='';
    arr.forEach(v=>{
      const el = document.createElement('button');
      el.className='pill'+(set.has(v)?' active':'');
      el.textContent=v||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
      el.onclick=()=>{ el.classList.toggle('active'); set.has(v)?set.delete(v):set.add(v); };
      wrap.appendChild(el);
    });
  };
  mk(levels, state.filters.level, '#levelPills');
  mk(cats, state.filters.category, '#categoryPills');
  mk(poss, state.filters.pos, '#posPills');

  $('#applyFilter').onclick=()=>{ save(); applyFilters(); $('#sheetFilter').close(); };
}

// ========= Settings Bind =========
function bindSettings(){
  $('#toggleTapToFlip').checked = state.tapToFlip;
  $('#toggleAutoAdvance').checked = state.autoAdvance;
  $('#toggleTapToFlip').onchange = e => { state.tapToFlip = !!e.target.checked; save(); };
  $('#toggleAutoAdvance').onchange = e => { state.autoAdvance = !!e.target.checked; save(); };
  $('#btnReset').onclick = ()=>{
    if(confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤/‡∏î‡∏≤‡∏ß ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){
      state.stars = {}; save();
      openToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
    }
  };
}

// ========= Stars Review Page =========
function openStarsPage(){
  $('header .back-btn').hidden = false;
  $('main').hidden = true;
  $('#starsPage').hidden = false;

  const wrap = $('#starsWrap');
  wrap.innerHTML = '';
  for(let s=5; s>=0; s--){
    const group = document.createElement('div');
    group.className='star-group';
    const head = document.createElement('div');
    head.className='star-head';
    head.innerHTML = `<strong>${s} ‚òÖ</strong><span style="color:#64748b">‡∏ù‡∏∂‡∏Å‡∏à‡∏≥ ${s===0?'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°':s+' ‡∏î‡∏≤‡∏ß'}</span>`;
    const list = document.createElement('div');
    list.className='word-list';

    const ids = Object.entries(state.stars).filter(([id,st])=>st===s).map(([id])=>id);
    const items = state.all.filter(w=>ids.includes(w.id));
    if(items.length===0){
      const none = document.createElement('div');
      none.style.color='#9aa3b2'; none.style.padding='6px 10px';
      none.textContent='‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ ‚Äî';
      list.appendChild(none);
    }else{
      items.forEach(w=>{
        const chip = document.createElement('div');
        chip.className='word-chip';
        chip.textContent = (w.kanji || w.kana) + ' ‚Ä¢ ' + (w.meaning||'');
        chip.onclick = ()=> {
          // jump to this word
          const idxInPool = state.pool.findIndex(x=>x.id===w.id);
          if(idxInPool>=0){ state.idx=idxInPool; }
          else{
            state.filters.level = new Set([w.level]);
            state.filters.category = new Set([w.category]);
            applyFilters();
            state.idx = state.pool.findIndex(x=>x.id===w.id);
          }
          goHome();
          setCard(state.pool[state.idx]);
        };
        list.appendChild(chip);
      });
    }

    group.appendChild(head); group.appendChild(list); wrap.appendChild(group);
  }
}
function goHome(){
  $('header .back-btn').hidden = true;
  $('#starsPage').hidden = true;
  $('main').hidden = false;
}

// ========= Events =========
$('#btnFlip').onclick = flip;
$('#flashcard').addEventListener('click', ()=> { if(state.tapToFlip) flip(); });
$('#flashcard').addEventListener('keypress', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); flip(); }});

$('#btnKnow').onclick = ()=> mark(true);
$('#btnDont').onclick = ()=> mark(false);

$('#btnPrev').onclick = ()=> next(-1);
$('#btnNext').onclick = ()=> next(1);

$('#btnShuffle').onclick = ()=>{
  // Fisher‚ÄìYates
  for (let i = state.pool.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [state.pool[i], state.pool[j]] = [state.pool[j], state.pool[i]];
  }
  state.idx = 0; setCard(state.pool[state.idx]);
};
$('#btnStars').onclick = openStarsPage;
$('header .back-btn').onclick = goHome;

// ========= Init =========
(async function init(){
  restore();
  state.all = await loadData();
  buildFilterUI();
  bindSettings();
  applyFilters();
})();
